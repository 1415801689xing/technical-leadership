# 工程方法-代码评审

> 怎样才能做好代码评审呢？**做好代码审查的一个前提条件就是，要找到适合自己团队的方法。**要做到这一点，就要对代码审查有一个深入的了解，弄清楚常用方式及适用场景，然后才能做出正确选择。以下是详细分析代码审查方式以及适用的场景，咱们将结合以下不同方式进行实践。

## 代码审查时主要关注以下内容

- 设计：代码是否经过设计并适合当前系统？
- 功能性：代码是否符合开发者的预期意图，代码对用户的行为方式好吗？
- 复杂性：可以简化代码吗？将来，当其他开发人员遇到该代码时，他们是否能够轻松地理解和使用该代码？
- 测试：代码中是否包含正确且设计良好的自动化测试？【目前未利用起来】
- 命名：开发人员是否为变量、类，方法等选择了清晰的名称？
- 注释：注释是否清晰有用？
- 规范：代码是否遵循我们的编码规范？
- 文档：开发人员是否更新了相关文档？【暂时针对设计流程】

## 代码评审作用

**作用1，尽早发现Bug和设计中存在的问题。**

**作用2，提高个人工程能力。**

**作用3，团队知识共享。**

**作用4，针对某个特定方面提高质量。**

**作用5，统一编码风格。**

## 审查方法

### 1. 按审查方式分类

> 按照审查方式，代码审查可以分为工具辅助的**线下异步审查**和**面对面审查**两类。

#### 1.1 工具辅助的线下异步检查

> 开发人员通过工具将代码发送给审查组，审查组再通过工具把反馈传递给开发人员。比如gitHub, gitLab, Gerrit, Phabricator等工具的审查。

- 具体的gitLab审查流程，请查阅[gitLab-code-review](./gitLab-code-review.md)

- 优点
  - 审查组可以控制审查时间，减少对审查组的工作的干扰。比如，审查组可以用一两个小时的时间，来集中处理多个代码审查要求。
  - 在工具中的讨论会留下文档，方便以后参考。

> 相应地，使用这种方式的**缺点是实时性不好**。但，这个问题很容易解决。比如，你可以在工具上发出审查要求，然后跑到审查者办公桌前进行面对面讨论。

#### 1.2 面对面审核

> 就是审查组合开发人员在一块阅读代码，进行实时讨论。

- 优点：快，可以高效地审查不方便用文字讨论的代码。比如，架构问题的讨论。

- 缺点：对审查组的干扰很大，如果大量使用的话会影响审查组的心流。一个可降低干扰的方法是，提前约时间。

### 2. 按审查人数分类

> 按审查人数，代码审查可以分一对一审查和团队审查两类。

#### 2.1 一对一审查

> 审查者单独进行审查

- 面对面的一对一审查
- 基于工具的异步审查

#### 2.2 团队审查

> 团队成员聚在一起讨论代码

- 专项讨论，集体讨论关键代码。

### 3. 按审查范围分类

> 审查范围，代码审查可以分为增量和全量。

#### 3.1 增量审查

> 只针对改动部分进行审查。

- 需要注意的是，在审查新的代码改动时，一定要一同考虑相关代码，看看是否会因为新代码的引入造成问题。另外，也需要注意是否会有旧的代码，可以被重构掉。

#### 3.2 全量审查

> 对现有代码的全量，比如说整个文件、某几个函数进行审查。

- 适合场景：
  - 专项检查
  - 引入代码审查时，对遗产代码进行一次审查

- 优点：能关注整体质量；
- 缺点：工作量大，因此不能常常进行，大版本迭代时可执行；

### 4. 按审查时机分类

- 分为以下三大类：
  - 代码入库前检查
  - 设计时检查
  - 代码入库后检查

#### 4.1 入库前检查

> 把代码审查作为门禁的一部分，要求代码在入库前必须通过人工审查，比如gitLab工具里面的PR审查。

- 目前已使用的入库前的工具：
  - eslint 严格检测
  - commit message 标准规范
  - gitLab Jenkins、SonarQube 自动化机器检测

#### 4.2 设计时检查

> 设计阶段进行代码审查，主要是讨论代码的架构设计是否有问题。

- 需要有设计流程文档；【归纳confluence】
- **强烈建议尽量使用代码设计时审查**

#### 4.3 入库后检查

> 检查已经入库的代码。提高遗产代码的质量。

- phabricator的审计功能；

## 代码审查实践
